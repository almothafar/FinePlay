@import views.html._
@import views.html.components

@import common.system._
@import models.components._

@(pagingInfo:PagingInfo, rowsJson:String)

@import models.components._
@import scala.collection.immutable._
@import scala.collection.immutable.Map
@import scala.collection.immutable.Seq
@import scala.collection.immutable.List
@import scala.collection.JavaConversions._

@frame(){

	@head("lab"){

		@libraries.standard.head()
		@libraries.handsontable.head()
	}

	@body("lab","library"){

		@components.container(Map("id"->"", "fluid"->"true", "class"->"mt-3")){
			@breadcrumb(Map("id"->"", "name"->"Handsontable", "icon"->"fa fa-pencil", "selected"->"true"))
		}

		@components.container(Map("id"->"", "fluid"->"true")){
			<div class="row">
				<div class="col-md-3">

					@tasks(Map("id"->"", "task"->"handsontable"))
				</div>
				<div class="mt-3 d-md-none">
				</div>
				<div class="col-md-9">

					<div class="mb-3">

						<div id="hot_container"></div>

						@components.container(Map("id"->"hot_pagination", "fluid"->"true", "class"->"mt-3")){
							<ul class="pagination pagination- justify-content-center">
								<li class="page-item"><a class="page-link" href="#0" aria-label="First"><span aria-hidden="true">@Messages(MessageKeys.FIRST)</span></a></li>
								<li class="page-item"><a class="page-link" href="#p" aria-label="Previous"><span aria-hidden="true">@Messages(MessageKeys.PREVIOUS)</span></a></li>
								@for(i <- 0 to pagingInfo.getPageCount() - 1){
									<li class="page-item"><a class="page-link" href="#@i">@(i+1)</a></li>
								}
								<li class="page-item "><a class="page-link" href="#n" aria-label="Next"><span aria-hidden="true">@Messages(MessageKeys.NEXT)</span></a></li>
								<li class="page-item "><a class="page-link" href="#@(pagingInfo.getPageCount() - 1)" aria-label="Last"><span aria-hidden="true">@Messages(MessageKeys.LAST)</span></a></li>
							</ul>
						}
					</div>
				</div>
			</div>
		}

		@libraries.standard.last()
		@libraries.handsontable.last()
		@script(){

			var getData = (function () {

				var data = JSON.parse('@Html(rowsJson)');

				return function () {

					var page = parseInt(window.location.hash.replace('#', ''), 10) || 0,
						limit = @pagingInfo.getPageSize(),
						row	 = page * limit,
						count = (page + 1) * limit,
						part = [];

					for (;row < count;row++) {
						part.push(data[row]);
					}

					return part;
				}
			})();

			var container = document.getElementById('hot_container');
			var hot = new Handsontable(container, {

				data: getData(),
				rowHeaders: true,
				colHeaders: true,
				dropdownMenu: true,
				contextMenu: true
			});

			var redraw = function(){

				hot.updateSettings({

					height: $("#hot_container .htCore").height()
				});
			}

			$('#hot_pagination>.pagination>.page-item>a[href^=\"#\"].page-link').on('click', function() {

				var currentPage = parseInt(window.location.hash.replace('#', ''), 10) || 0;

				var href = $(this).attr("href");
				var targetPage;
				var target = href.replace('#', '')
				switch (target){
					case 'p':

						targetPage = currentPage - 1;
						break;
					case 'n':

						targetPage = currentPage + 1;
						break;
					default:

						targetPage = parseInt(target, 10) || 0;
						break;
				}

				var visibleCount = 3;
				var visibleIndexs = [];

				visibleIndexs.push(targetPage);
				do {

					if (visibleIndexs.length < visibleCount) {

						var last = visibleIndexs[visibleIndexs.length - 1];
						if (last < @pagingInfo.getPageCount() - 1) {

							var next = last + 1;
							visibleIndexs.push(next);
						}
					}

					if (visibleIndexs.length < visibleCount) {

						var head = visibleIndexs[0];
						if (0 < head) {

							var prev = head - 1;
							visibleIndexs.unshift(prev);
						}
					}
				} while (visibleIndexs.length < visibleCount);

				var isEnabledFirst = 0 < targetPage;
				var isEnabledPrevious =  0 < targetPage;
				var isEnabledNext = targetPage < @pagingInfo.getPageCount() - 1;
				var isEnabledLast = targetPage < @pagingInfo.getPageCount() - 1;

				var pageItems = $('#hot_pagination>.pagination>.page-item');
				isEnabledFirst ? pageItems.eq(0).removeClass('disabled') : pageItems.eq(0).addClass('disabled');
				isEnabledPrevious ? pageItems.eq(1).removeClass('disabled') : pageItems.eq(1).addClass('disabled');
				for(i = 2;i < pageItems.length -2;i++){
					var pageItem = pageItems.eq(i);
					visibleIndexs.indexOf(i-2) != -1 ? pageItem.show() : pageItem.hide();
					targetPage == (i-2) ? pageItem.addClass('active') : pageItem.removeClass('active');
				}
				isEnabledNext ? pageItems.eq(pageItems.length - 2).removeClass('disabled') : pageItems.eq(pageItems.length - 2).addClass('disabled');
				isEnabledLast ? pageItems.eq(pageItems.length - 1).removeClass('disabled') : pageItems.eq(pageItems.length - 1).addClass('disabled');

				window.location.hash = targetPage;

				return false;
			});

			Handsontable.dom.addEvent(window, 'hashchange', function (event) {

				hot.loadData(getData());
				redraw();
			});

			$(window).resize(function(){

				redraw();
			});

			$('#hot_pagination>.pagination>.page-item>a[href^=\"#\"].page-link').eq(0).trigger('click');
		}
	}
}
