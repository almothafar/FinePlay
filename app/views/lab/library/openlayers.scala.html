@import models.components._
@import scala.collection.immutable._
@import scala.collection.immutable.Map
@import scala.collection.immutable.Seq
@import scala.collection.immutable.List
@import scala.collection.JavaConversions._
@import views.html._
@import views.html.components
@import play.api.i18n._

@import common.system._

@()

@frame(){

	@head("lab"){

		@libraries.standard.head()
		@libraries.openlayers.head()
		@style(){
			@@media (min-width: 0em) {
				#map {
					height:360px;
				}
			}
			@@media (min-width: 48em) {
				#map {
					height:540px;
				}
			}
		}
	}

	@body("lab","library"){

		@components.container(Map("id"->"", "fluid"->"true", "class"->"mt-3")){
			@breadcrumb(Map("id"->"", "name"->"OpenLayers", "icon"->"fa fa-pencil", "selected"->"true"))
		}

		@components.container(Map("id"->"", "fluid"->"true")){
			<div class="row">
				<div class="col-md-3">

					@tasks(Map("id"->"", "task"->"openlayers"))
				</div>
				<div class="mt-3 d-md-none">
				</div>
				<div class="col-md-9">

					<div class="mb-3">
					@components.linkbutton(Map("id"->"", "type"->"link", "icon"->"fa fa-link", "text"->"Go to map", "link"->"#map"))

						<div id="map" class="map" tabindex="0" style=""></div>

						@components.buttongroup(Map("id"->""), List(
							Map("id"->"zoomOutButton", "type"->"primary", "outline"->"true", "icon"->"fa fa-compress", "text"->Messages(MessageKeys.ZOOMOUT)),
							Map("id"->"zoomInButton", "type"->"primary", "outline"->"true", "icon"->"fa fa-expand", "text"->Messages(MessageKeys.ZOOMIN))
						))

						@components.buttongroup(Map("id"->""), List(
							Map("id"->"geolocationButton", "type"->"primary", "outline"->"true", "icon"->"fa fa-location-arrow", "text"->"", "data-toggle"->"button", "aria-pressed"->"false")
						))
					</div>
				</div>
			</div>
		}

		@libraries.standard.last()
		@libraries.openlayers.last()
		@script(){

			var view = new ol.View({
				center: [0, 0],
				zoom: 2
			});

			var map = new ol.Map({
				layers: [
					new ol.layer.Tile({
						source: new ol.source.OSM()
					})
				],
				target: 'map',
				controls: ol.control.defaults({
					attributionOptions: /** @@type {olx.control.AttributionOptions} */ ({
						collapsible: false
					})
				}),
				view: view
			});

			document.getElementById('zoomOutButton').onclick = function() {

				var view = map.getView();
				var zoom = view.getZoom();
				view.setZoom(zoom - 1);
			};

			document.getElementById('zoomInButton').onclick = function() {

				var view = map.getView();
				var zoom = view.getZoom();
				view.setZoom(zoom + 1);
			};

			var geolocation = new ol.Geolocation({

				projection: view.getProjection()
			});

			var accuracyFeature = new ol.Feature();
			geolocation.on('change:accuracyGeometry', function() {

				accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());
			});

			var positionFeature = new ol.Feature();
			positionFeature.setStyle(new ol.style.Style({
				image: new ol.style.Circle({
					radius: 6,
					fill: new ol.style.Fill({
						color: '#3399CC'
					}),
					stroke: new ol.style.Stroke({
						color: '#fff',
						width: 2
					})
				})
			}));

			geolocation.on('change:position', function() {

				var coordinates = geolocation.getPosition();

				positionFeature.setGeometry(coordinates ? new ol.geom.Point(coordinates) : null);

				if(coordinates){

					view.setCenter(coordinates);
				}
			});

			new ol.layer.Vector({
				map: map,
				source: new ol.source.Vector({
					features: [accuracyFeature, positionFeature]
				})
			});

			$("#geolocationButton").on('click', function(e) {

				var isStartTrack = $("#geolocationButton").attr('aria-pressed') == 'false';
				geolocation.setTracking(isStartTrack);
			});

			var deviceOrientation = new ol.DeviceOrientation();

			deviceOrientation.on(['change:heading'], function(event) {

				var rotation = event.target.getHeading() || 0;

				view.setRotation(rotation);
			});

			$("#orientationButton").on('click', function(e) {

				var isStartTrack = $("#orientationButton").attr('aria-pressed') == 'false';
				deviceOrientation.setTracking(isStartTrack);
			});
		}
	}
}
