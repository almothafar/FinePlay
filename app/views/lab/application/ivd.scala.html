@import models.components._
@import common.system._

@()

@import scala.collection.immutable._
@import scala.collection.immutable.Map
@import scala.collection.immutable.Seq
@import scala.collection.immutable.List
@import scala.collection.JavaConversions._
@import views.html._
@import views.html.components

@frame(){

	@head("lab"){

		@libraries.standard.head()
		<link rel='stylesheet' href='@routes.Assets.versioned("stylesheets/lab/application/ivd.css")'>
	}

	@body("lab","application"){

		@components.container(Map("id"->"", "fluid"->"true", "class"->"mt-3")){
			@breadcrumb(Map("id"->"", "name"->"IVD", "icon"->"fa fa-print", "selected"->"true"))
		}

		@components.container(Map("id"->"", "fluid"->"true")){
			<div class="row">
				<div class="col-md-3">

					@tasks(Map("id"->"", "task"->"ivd"))
				</div>
				<div class="mt-3 d-md-none">
				</div>
				<div class="col-md-9">

					<div class="mb-3">

						@components.linkbutton(Map("id"->"", "type"->"link", "icon"->"fa fa-link", "text"->Messages(MessageKeys.SETTING), "link"->controllers.setting.system.routes.System.index("font").toString))
					</div>

					<div class="mb-3">
						<h4 class="headline">@Messages(MessageKeys.FONT_HIRAGINOSANS__W3)</h4>
						<div class="row form-group">
							<div class="col-12">
								<input id="adobe-japan1Text" class="form-control inputText adobe-japan1" type="text" placeholder="" value="">
							</div>
						</div>
					</div>

					<div class="mb-3">
						<h4 class="headline">@Messages(MessageKeys.FONT_IPAMJMINCHO)</h4>
						<div class="row form-group">
							<div class="col-12">
								<input id="hanyo-denshiText" class="form-control inputText hanyo-denshi" type="text" placeholder="" value="">
							</div>
						</div>
					</div>

					<div class="mb-3">

						@components.modal(Map("id"->"pickerWindow", "icon"->"fa fa-font", "title"->Messages(MessageKeys.SELECT), "data-backdrop"->"static", "size"->"lg"), List(
								Map("id"->"ajaxCancel", "type"->"primary", "outline"->"true", "text"->Messages(MessageKeys.CANCEL), "data-dismiss"->"modal"),
								Map("id"->"okButton", "type"->"primary", "text"->Messages(MessageKeys.OK), "data-toggle"->"modal", "data-target"->"#pickerWindow", "data-whatever"->"okButton", "default"->"true")
							)){
							<div>
								<p class="text-warning"></p>
							</div>
							<div class="row form-group mb-0">
								<label for="inputType" class="col-sm-3 col-form-label">@Messages(MessageKeys.TYPE)</label>
								<div class="col-sm-9">
									@for(character_type <- apis.character.Character.Type.values()) {
									<label class="custom-control custom-radio">
										<input class="custom-control-input type" type="radio" name="searchType" value="@character_type.toString()" @("checked".when(apis.character.Character.Type.CHARACTER == character_type))>
										<span class="custom-control-indicator"></span>
										@Messages(character_type.getMessageKey())
									</label>
									}
								</div>
							</div>
							<div class="row form-group mb-0">
								<label for="searchText" class="col-sm-3 col-form-label required">@(Messages(MessageKeys.SEARCH)+" "+Messages(MessageKeys.VALUE))</label>
								<div class="col-sm-9">
									<input id="searchText" type="text" name="searchText" class="form-control" placeholder="" value="" required autofocus>
									<small class="text-muted">Description of search value.</small>
									<div>
										<p class="text-warning"></p>
									</div>
								</div>
							</div>
							@components.container(Map("id"->"", "fluid"->"true")){
								<div class="row">
									<h3 id="character">
										Base character
										<small class="text-muted">Base character info.</small>
									</h3>
								</div>
								<div class="row">@Messages(MessageKeys.VARIATION)</div>
								<div id="variations" class="row mb-3">
								</div>
							}
							<div class="wordwrap">
								<div id="ajaxMessage" class="lead"></div>
								<div id="ajaxDescription">-</div>
							</div>
							@components.progress(Map("id"->"ajaxProgress", "value"->"0", "max"->"100", "striped"->"true", "animated"->"true"))
						}

						@components.button(Map("id"->"", "type"->"primary", "outline"->"true", "text"->Messages(MessageKeys.SELECT), "data-toggle"->"modal", "data-target"->"#pickerWindow"))
					</div>

					<div class="mt-3"></div>
				</div>
			</div>
		}

		@libraries.standard.last()
		@libraries.holder.last()
		@script(){

			var currentLink = '@helper.CSRF(apis.character.routes.Character.character("type", "text"))';
			var currentLinkArray = currentLink.split(/\?.*(?=csrfToken)/);
			var characterLink = currentLinkArray[0]+'?'+currentLinkArray[1];

			var initInput = function(){

				$('input[name=searchType]').eq(0).prop('checked', true);
				$('input[name=searchText]').val('');
			};
			var initResult = function(){

				$('#character').empty();

				$('#variations').empty();
				emptyVariations();

				$('#ajaxMessage').text('');
				$('#ajaxDescription').text('-');
				$('#ajaxProgress>.progress-bar').removeClass('bg-danger').css('width', '0%');
				$('#ajaxCancel').prop('disabled', false);
			};

			var emptyVariations = function(){

				$('#variations').append('<div class="mx-auto font-weight-bold text-muted">@Messages(MessageKeys.X__IS__X, Messages(MessageKeys.VARIATION), Messages(MessageKeys.EMPTY))</div>');
			};

			var adobeJapan1Position;
			var hanyoDenshiPosition;
			$('#pickerWindow').on('shown.bs.modal', function (e) {

				adobeJapan1Position = getPosition('#adobe-japan1Text');
				hanyoDenshiPosition = getPosition('#hanyo-denshiText');

				initInput();
				initResult();

				$('input[name=searchText]').focus();
			})

			var search = function(){

				var type = $('input[name=searchType]:checked').val();
				var text = $('input[name=searchText]').val();

				if(0 == text.length){

					initResult();
					return;
				}

				initResult();
				$('#ajaxCancel').prop('disabled', true);
				$('#ajaxMessage').text('@Messages(MessageKeys.PLEASE__WAIT)');
				$('#ajaxProgress>.progress-bar').addClass('bg-primary').css('width', '100%')

				var timeout = "10000";
				$.ajax({
					method:"GET",
					url: characterLink,
					data: $.param({
							type: type,
							text: text
					}),
					contentType: 'text/plain',
					dataType: "json",
					timeout: timeout
				})
				.then(
					function (responseJson) {

						initResult();

						var codePoint = responseJson["codePoint"];
						var hex = responseJson["hex"];
						var character = responseJson["character"];
						var variations = responseJson["variations"];

						$('#character').html(character + '<small class="text-muted">' + '&nbsp;&nbsp;@Messages(MessageKeys.CODEPOINT):' + codePoint + '&nbsp;&nbsp;@Messages(MessageKeys.HEX):' + hex + '</small>');

						if(0 == variations.length){

							$('#variations').empty();
							emptyVariations();
						}else{

							$('#variations').empty();
							$.each(variations, function(i, key) {

								var variation = variations[i];

								var variationCodePoint = variation["codePoint"];
								var variationHex = variation["hex"];
								var variationSequence = variation["character"];
								var variationCollections = variation["collections"];

								var variationCharacter = (character+variationSequence);

								var cssClass = "";
								var idTip = "";
								$.each(variationCollections, function(key, val) {

									var variationCollection = variationCollections[key];

									var variationCollectionName = variationCollection["name"];
									cssClass = cssClass + " " + variationCollectionName.toLowerCase();

									var variationCollectionId = variationCollection["id"];
									idTip = idTip + variationCollectionId + '<br>';
								});

								var variation = '<div class="variation' + cssClass + '">' +
												'<div class="marker">' +
													'<i id="" class="fa fa-circle"></i><i id="" class="fa fa-circle "></i><i id="" class="fa fa-circle "></i><i id="" class="fa fa-circle "></i>' +
												'</div>' +
												'<div class="character">' + variationCharacter + '</div>' +
												'<small class="text-muted">' + variationHex +
													'<button id="" type="button" class="btn btn-link btn-sm p-0" title="' + idTip + '" data-toggle="tooltip" data-placement="top"><i id="" class="fa fa-info-circle"></i></button>' +
												'</small>' +
											'</div>';
								$('#variations').append(variation);
							});
						}

						$('[data-toggle="tooltip"]').tooltip({html: true});
					},
					function (jqXHR, textStatus, errorThrown) {

						$('#ajaxMessage').text('@Messages(MessageKeys.FAILURE)');
						$('#ajaxCancel').prop('disabled', false);
						var errorMessage = errorThrown;
						if(jqXHR.responseJSON){errorMessage = jqXHR.responseJSON['error'];}
						$('#ajaxDescription').html('@Messages(MessageKeys.STATUS)&nbsp;<strong>'+textStatus+'</strong>&nbsp;-&nbsp;@Messages(MessageKeys.ERROR)&nbsp;<strong>'+errorMessage+'</strong>');
						$('#ajaxProgress>.progress-bar').removeClass('bg-primary').addClass('bg-danger');
					}
				);
			}

			$('input[name=searchType]').on('change', function () {

				search();
			});

			var keyupEvents = [];
			$('input[name=searchText]').on('keyup', function () {

				keyupEvents.push('keyup');

				var searchText = $(this).val();
				setTimeout(function () {

					keyupEvents.pop();

					if (0 == keyupEvents.length) {

						search();
					}
				}, 500);
			});

			$('#variations').on('click', '.variation', function (e) {

				$('#variations>.variation.bg-primary').removeClass('bg-primary');
				var variation = $(this);
				variation.addClass('bg-primary');
			});

			$('#okButton').on('click', function (e) {

				var button = $(this);
				var selectedCharacter = $('#variations>.variation.bg-primary').children('.character').text();

				// possibility of dependant browser
				insertText('#adobe-japan1Text', adobeJapan1Position[0], adobeJapan1Position[1], selectedCharacter);
				insertText('#hanyo-denshiText', hanyoDenshiPosition[0], hanyoDenshiPosition[1], selectedCharacter);
			})

			$(window).on('keydown', function(e){

				var keyCode = e.which ? e.which : e.keyCode;
				if (13 == keyCode) {

					if($("#pickerWindow").is(".show")){

						$('#okButton').trigger("click");
					}

					e.preventDefault();
				}
			});

			var getPosition = function(selector){

				var element = document.querySelector(selector);
				var start = element.selectionStart;
				var end = element.selectionEnd;
				return [start, end];
			}

			var insertText = function(selector, start, end, text){

				var element = document.querySelector(selector);
				element.value = replaceText(element.value, start ,end ,text);
			}

			var replaceText = function(source, start, end, text){

				var right = source.substring(0, start);
				var middle = source.substring(start, end);
				var left = source.substring(end, source.length);

				return right + text + left;
			}
		}
	}
}
